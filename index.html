<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ospital ng Makati – Antimicrobial Request System (Pharmacy)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --osmak-green: #009a3e;
  --osmak-green-dark: #007530;
  --osmak-red: #dc2626;
  --bg-main: #f5f5f5;
  --bg-card: #ffffff;
  --text-main: #111827;
  --text-muted: #6b7280;
  --border: #d1d5db;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

header {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: var(--osmak-green);
  color: #fff;
  padding: 0.75rem 1rem;
}

header img {
  height: 48px;
}

header h1 {
  margin: 0;
  font-size: 1.2rem;
  text-transform: uppercase;
}
header span {
  font-size: 0.85rem;
  opacity: 0.9;
}

.main {
  max-width: 1200px;
  margin: 1rem auto;
  padding: 0 1rem;
}

.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.tab-btn {
  background: #fff;
  border: 1px solid var(--border);
  padding: 0.5rem 0.9rem;
  border-radius: 0.4rem;
  cursor: pointer;
}
.tab-btn.active {
  background: var(--osmak-green);
  color: #fff;
  border-color: var(--osmak-green-dark);
}

.section {
  display: none;
}
.section.active {
  display: block;
}

.card {
  background: var(--bg-card);
  padding: 1rem;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  margin-bottom: 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.4rem;
}

.tag {
  padding: 0.15rem 0.5rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}
.tag.monitored { background: rgba(0,154,62,0.15); color: var(--osmak-green-dark); }
.tag.restricted { background: rgba(220,38,38,0.15); color: var(--osmak-red); }

.actions {
  margin-top: 0.6rem;
  display: flex;
  gap: 0.4rem;
}

.btn {
  border: none;
  padding: 0.35rem 0.75rem;
  font-size: 0.8rem;
  border-radius: 0.4rem;
  cursor: pointer;
}
.btn.approve { background: var(--osmak-green); color: white; }
.btn.reject { background: var(--osmak-red); color: white; }
.btn.for-ids { background: #f59e0b; color: #fff; }
.btn.delete { background: #6b7280; color: #fff; }

.search-row {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 0.6rem;
}
.search-row input,
.search-row select {
  padding: 0.45rem;
  border: 1px solid var(--border);
  border-radius: 0.4rem;
}

.list-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  background: #fff;
}

.list-item {
  padding: 0.6rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.list-item:last-child {
  border-bottom: none;
}

.confirm-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
}

.confirm-box {
  background: #fff;
  padding: 1rem;
  border-radius: 0.5rem;
  width: 320px;
  max-width: 90%;
}
.confirm-box button {
  margin-top: 0.5rem;
}

</style>
</head>

<body>

<header>
  <img src="https://maxterrenal-hash.github.io/justculture/osmak-logo.png">
  <div>
    <h1>Antimicrobial Request System</h1>
    <span>Pharmacy Module</span>
  </div>
</header>

<div class="main">

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending</button>
    <button class="tab-btn" data-tab="approved">Approved</button>
    <button class="tab-btn" data-tab="rejected">Rejected</button>
    <button class="tab-btn" data-tab="dispensed">Dispensed</button>
    <button class="tab-btn" data-tab="ids">IDS Pending</button>
  </div>

  <!-- Pending Section -->
  <div class="section active" id="pending">
    <div class="search-row">
      <input type="date" id="pendingDate">
      <input type="text" id="pendingSearch" placeholder="Search Hospital Number">
    </div>
    <div id="pendingList"></div>
  </div>

  <!-- Approved Section -->
  <div class="section" id="approved">
    <div class="search-row">
      <input type="date" id="approvedDate">
      <input type="text" id="approvedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="approvedList"></div>
  </div>

  <!-- Rejected Section -->
  <div class="section" id="rejected">
    <div class="search-row">
      <input type="date" id="rejectedDate">
      <input type="text" id="rejectedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="rejectedList"></div>
  </div>

  <!-- Dispensed Section -->
  <div class="section" id="dispensed">
    <div class="search-row">
      <input type="date" id="dispensedDate">
      <input type="text" id="dispensedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="dispensedList"></div>
  </div>

  <!-- IDS Pending -->
  <div class="section" id="ids">
    <div class="search-row">
      <select id="idsFilter">
        <option value="">Filter by IDS</option>
        <option>Dr. Christopher John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
      <input type="date" id="idsDate">
    </div>
    <div class="list-container" id="idsList"></div>
  </div>

</div>

<!-- Confirmation Modal -->
<div class="confirm-backdrop" id="confirmBackdrop">
  <div class="confirm-box">
    <p id="confirmMsg"></p>
    <button id="confirmYes" class="btn approve">Yes</button>
    <button id="confirmNo" class="btn reject">Cancel</button>
  </div>
</div>

<script>
// === CONFIG ===
const API = "https://script.google.com/macros/s/AKfycbyFmc29khGH26fyQKgacNudxD3zA7QWN3JVB128afMnzzoY83KyH7Ddlrtg6G7hmxe8/exec";

let ALL_DATA = [];
let pendingAction = null;

// Utility: fetch all entries
async function loadData() {
  const res = await fetch(API);
  const data = await res.json();
  ALL_DATA = data.entries || [];
  renderAll();
}

// Utility: show confirmation modal
function confirmAction(msg, callback) {
  document.getElementById("confirmMsg").textContent = msg;
  pendingAction = callback;
  document.getElementById("confirmBackdrop").style.display = "flex";
}
document.getElementById("confirmNo").onclick = () => {
  document.getElementById("confirmBackdrop").style.display = "none";
  pendingAction = null;
};
document.getElementById("confirmYes").onclick = () => {
  if (pendingAction) pendingAction();
  document.getElementById("confirmBackdrop").style.display = "none";
};


// === RENDERERS ===

// Pending Cards
function renderPending() {
  const date = document.getElementById("pendingDate").value;
  const search = document.getElementById("pendingSearch").value.trim();

  const container = document.getElementById("pendingList");
  container.innerHTML = "";

  const data = ALL_DATA.filter(e => {
    const d = e.data;
    if (!d) return false;
    if (date && d.reqDate !== date) return false;
    if (search && !String(d.hospitalNumber).includes(search)) return false;
    if (d.status === "approved" || d.status === "disapproved" || 
        d.status === "dispensed" || d.status === "for_ids_approval") return false;
    return true;
  });

  data.forEach(e => {
    const d = e.data;
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="card-header">
        <strong>${d.patientName} (${d.age} y)</strong>
        <span class="tag ${d.drugType.toLowerCase()}">${d.drugType}</span>
      </div>
      <div><strong>Hospital #:</strong> ${d.hospitalNumber}</div>
      <div><strong>Ward:</strong> ${d.ward}</div>
      <div><strong>Diagnosis:</strong> ${d.diagnosis}</div>
      <div><strong>Drug:</strong> ${d.antimicrobial} (${d.dose}, ${d.frequency}, ${d.duration}d)</div>
      <div><strong>Indication:</strong> ${d.indication}</div>
      <div><strong>Resident:</strong> ${d.residentName}</div>
      <div><strong>Date:</strong> ${d.reqDate}</div>

      <div class="actions">
        ${
          d.drugType === "Restricted"
          ? `
              <button class="btn for-ids">For IDS Approval</button>
              <button class="btn delete">Delete</button>
            `
          : `
              <button class="btn approve">Approved</button>
              <button class="btn reject">Disapproved</button>
              <button class="btn delete">Delete</button>
            `
        }
        <label><input type="checkbox" class="dispCheck"> Dispensed</label>
      </div>
    `;

    // Button actions
    const approveBtn = card.querySelector(".approve");
    if (approveBtn) approveBtn.onclick = () => {
      confirmAction("Approve this request?", () => updateStatus(e.fileId, "approved"));
    };

    const rejectBtn = card.querySelector(".reject");
    if (rejectBtn) rejectBtn.onclick = () => {
      confirmAction("Disapprove this request?", () => updateStatus(e.fileId, "disapproved"));
    };

    const forIdsBtn = card.querySelector(".for-ids");
    if (forIdsBtn) forIdsBtn.onclick = () => {
      confirmAction("Send to IDS for approval?", () => updateStatus(e.fileId, "for_ids_approval"));
    };

    const deleteBtn = card.querySelector(".delete");
    deleteBtn.onclick = () => {
      confirmAction("Delete this entry?", () => deleteEntry(e.fileId));
    };

    const dispCheck = card.querySelector(".dispCheck");
    dispCheck.onchange = () => {
      confirmAction("Mark as dispensed?", () => markDispensed(e.fileId));
    };

    container.appendChild(card);
  });
}


// List Renderer for Approved / Rejected / Dispensed / IDS
function renderList(tab, listId, filters) {
  const date = document.getElementById(filters.dateField).value;
  const search = document.getElementById(filters.searchField).value.trim();
  const ids = filters.idsField ? document.getElementById(filters.idsField).value : "";

  const container = document.getElementById(listId);
  container.innerHTML = "";

  let data = ALL_DATA.filter(e => {
    const d = e.data;
    if (!d) return false;

    if (filters.matchStatus && d.status !== filters.matchStatus) return false;
    if (filters.matchDrugType && d.drugType !== filters.matchDrugType) return false;

    if (filters.excludeStatuses && filters.excludeStatuses.includes(d.status)) return false;

    if (date && d.reqDate !== date) return false;
    if (search && !String(d.hospitalNumber).includes(search)) return false;

    if (ids && d.idSpecialist !== ids) return false;

    return true;
  });

  data.slice(0, 200).forEach(e => {
    const d = e.data;

    const row = document.createElement("div");
    row.className = "list-item";
    row.innerHTML = `
      <div>
        <strong>${d.patientName}</strong> (${d.hospitalNumber})<br>
        ${d.antimicrobial} – ${d.dose} (${d.frequency})
      </div>
      <div>${d.reqDate}</div>
    `;

    container.appendChild(row);
  });
}


// === Update actions ===
async function updateStatus(fileId, status) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "updateStatus", fileId, status })
  });
  loadData();
}

async function markDispensed(fileId) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "markDispensed", fileId })
  });
  loadData();
}

async function deleteEntry(fileId) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "deleteEntry", fileId })
  });
  loadData();
}


// === TAB SWITCHING ===
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".section").forEach(sc => sc.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");

    renderAll();
  };
});


// === RENDER ALL ===
function renderAll() {
  renderPending();

  renderList("approved", "approvedList", {
    dateField: "approvedDate",
    searchField: "approvedSearch",
    matchStatus: "approved",
    matchDrugType: "Monitored"
  });

  renderList("rejected", "rejectedList", {
    dateField: "rejectedDate",
    searchField: "rejectedSearch",
    matchStatus: "disapproved"
  });

  renderList("dispensed", "dispensedList", {
    dateField: "dispensedDate",
    searchField: "dispensedSearch",
    excludeStatuses: ["approved", "disapproved", "for_ids_approval"]
  });

  renderList("ids", "idsList", {
    dateField: "idsDate",
    searchField: "approvedSearch", // not used here
    matchStatus: "for_ids_approval",
    idsField: "idsFilter"
  });
}


// INIT
window.onload = loadData;
</script>

</body>
</html>
