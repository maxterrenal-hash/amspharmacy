<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ospital ng Makati – Antimicrobial Request System (Pharmacy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

<style>

/* ==========================================================
   THEME COLORS
   ========================================================== */
:root {
  --osmak-green: #009a3e;
  --osmak-green-dark: #007530;
  --osmak-red: #dc2626;
  --amber: #f59e0b;
  --amber-dark: #b45309;
  --bg-main: #f5f5f5;
  --bg-card: #ffffff;
  --text-main: #111827;
  --text-muted: #6b7280;
  --border: #d1d5db;
}

/* ==========================================================
   BASE LAYOUT
   ========================================================== */
body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

header {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: var(--osmak-green);
  color: #fff;
  padding: 0.75rem 1rem;
}

header img { height: 48px; }
header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; }

/* ==========================================================
   MAIN CONTAINER
   ========================================================== */
.main {
  max-width: 1200px;
  margin: 1rem auto;
  padding: 0 1rem;
}

/* ==========================================================
   TABS
   ========================================================== */
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.tab-btn {
  background: #fff;
  border: 1px solid var(--border);
  padding: 0.5rem 0.9rem;
  border-radius: 0.4rem;
  cursor: pointer;
  font-size: 0.85rem;
}
.tab-btn.active {
  background: var(--osmak-green);
  color: #fff;
  border-color: var(--osmak-green-dark);
}

.section { display: none; }
.section.active { display: block; }

/* ==========================================================
   SEARCH / FILTER ROWS
   ========================================================== */
.search-row {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 0.7rem;
}
.search-row input,
.search-row select {
  padding: 0.45rem;
  border: 1px solid var(--border);
  border-radius: 0.4rem;
  font-size: 0.9rem;
}

/* ==========================================================
   PENDING CARDS
   ========================================================== */
.card {
  background: var(--bg-card);
  padding: 1rem;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  margin-bottom: 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  cursor: pointer;
}

.card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.4rem;
}

/* Pill Tags */
.tag {
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  font-size: 0.72rem;
  font-weight: 600;
}
.tag.monitored {
  color: var(--osmak-green-dark);
  background: rgba(0,154,62,0.15);
}
.tag.restricted {
  color: var(--osmak-red);
  background: rgba(220,38,38,0.15);
}
.tag.ids-pill {
  background: rgba(245,158,11,0.22);
  border: 1px solid var(--amber);
  color: var(--amber-dark);
}

/* ==========================================================
   LIST ITEMS
   ========================================================== */
.list-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid var(--border);
  background: #fff;
  border-radius: 0.5rem;
}
.list-item {
  padding: 0.7rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  cursor: pointer;
}
.list-item:hover { background: #fafafa; }

/* ==========================================================
   BUTTONS
   ========================================================== */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin-top: 0.6rem;
}

.btn {
  border: none;
  padding: 0.4rem 0.75rem;
  font-size: 0.8rem;
  border-radius: 0.4rem;
  cursor: pointer;
}
.btn.approve { background: var(--osmak-green); color: white; }
.btn.reject { background: var(--osmak-red); color: white; }
.btn.for-ids { background: var(--amber); color: #fff; }
.btn.delete { background: #6b7280; color: white; }

/* ==========================================================
   MODALS
   ========================================================== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 40;
}

.modal-box {
  background: #fff;
  border-radius: 0.75rem;
  width: 90%;
  max-width: 720px;
  max-height: 85vh;
  overflow-y: auto;
}

.modal-header {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-body {
  padding: 1rem;
  font-size: 0.9rem;
  line-height: 1.4rem;
}
.close-btn {
  background: none;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
}

/* ==========================================================
   CONFIRMATION MODAL
   ========================================================== */
.confirm-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}
.confirm-box {
  background: #fff;
  padding: 1rem;
  border-radius: 0.6rem;
  width: 320px;
}

/* ==========================================================
   DATA ANALYSIS RESPONSIVE
   ========================================================== */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
@media (max-width: 800px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}
.tile {
  padding: 1rem;
  border-radius: 0.7rem;
  background: white;
  border: 1px solid var(--border);
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.tile-number {
  font-size: 2rem;
  font-weight: 700;
  margin-top: 0.4rem;
}

/* ==========================================================
   IMPORTANT: MOBILE PATCHES
   ========================================================== */
@media (max-width: 600px) {

  header {
    flex-direction: column;
    text-align: center;
  }

  .tab-btn {
    flex: 1 1 calc(50% - 0.4rem);
    text-align: center;
  }

  .search-row { flex-direction: column; }

  .card { padding: 0.75rem; }

  .actions { flex-direction: column; }
  .btn { width: 100%; }

  .list-item { flex-direction: column; align-items: flex-start; }

  .modal-box {
    width: 95%;
    max-height: 90vh;
  }
}

</style>
</head>

<body>

<header>
  <img src="https://maxterrenal-hash.github.io/justculture/osmak-logo.png">
  <div>
    <h1>Antimicrobial Request System</h1>
    <span>Pharmacy Module</span>
  </div>
</header>

<div class="main">

  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending</button>
    <button class="tab-btn" data-tab="approved">Approved</button>
    <button class="tab-btn" data-tab="rejected">Rejected</button>
    <button class="tab-btn" data-tab="ids">IDS Approval</button>
    <button class="tab-btn" data-tab="analysis">Data Analysis</button>
  </div>

  <!-- ==========================================================
       PENDING TAB
       ========================================================== -->
  <div class="section active" id="pending">
    <div class="search-row">
      <input type="date" id="pendingDate">
      <input type="text" id="pendingSearch" placeholder="Search Hospital Number">
    </div>
    <div id="pendingList"></div>
  </div>

  <!-- ==========================================================
       APPROVED TAB
       ========================================================== -->
  <div class="section" id="approved">
    <div class="search-row">
      <input type="date" id="approvedDate">
      <input type="text" id="approvedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="approvedList"></div>
  </div>

  <!-- ==========================================================
       REJECTED TAB
       ========================================================== -->
  <div class="section" id="rejected">
    <div class="search-row">
      <input type="date" id="rejectedDate">
      <input type="text" id="rejectedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="rejectedList"></div>
  </div>

  <!-- ==========================================================
       IDS APPROVAL TAB
       ========================================================== -->
  <div class="section" id="ids">
    <div class="search-row">
      <select id="idsFilter">
        <option value="">Filter by IDS</option>
        <option>Dr. Christopher John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
      <input type="date" id="idsDate">
    </div>
    <div class="list-container" id="idsList"></div>
  </div>

  <!-- ==========================================================
       DATA ANALYSIS TAB
       ========================================================== -->
  <div class="section" id="analysis">
    <div class="search-row">
      <input type="date" id="fromDate">
      <input type="date" id="toDate">
      <select id="wardFilter"></select>
      <button class="btn approve" id="applyAnalysis">Apply Filters</button>
    </div>

    <div style="display:flex; gap:0.5rem; margin-bottom:0.8rem;">
      <button class="btn approve" id="exportFilteredCsv">Export Filtered CSV</button>
      <button class="btn delete" id="exportAllCsv">Export ALL CSV</button>
    </div>

    <div class="dashboard-grid" id="analysisTiles"></div>

    <canvas id="chartRequests" height="180" style="margin-top:1rem;"></canvas>
    <canvas id="chartTypes" height="180" style="margin-top:1rem;"></canvas>
    <canvas id="chartApproval" height="180" style="margin-top:1rem;"></canvas>

    <h3>Top Antibiotics</h3>
    <div id="topAbx"></div>

    <h3>Top Wards</h3>
    <div id="topWards"></div>
  </div>

</div>


<!-- ==========================================================
     MODALS (DETAILS, PHARMACIST, CONFIRMATION, REASON)
     ========================================================== -->

<div class="modal-backdrop" id="detailsBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Request Details</h3>
      <button class="close-btn" id="detailsClose">✕</button>
    </div>
    <div class="modal-body" id="detailsBody"></div>
  </div>
</div>

<div class="modal-backdrop" id="pharmacistBackdrop">
  <div class="modal-box">
    <div class="modal-header"><h3>Dispensed By</h3></div>
    <div class="modal-body">
      <label>Pharmacist Name:</label>
      <input type="text" id="pharmacistName" class="pharm-input" style="width:100%;">
      <button class="btn approve" id="pharmacistSubmit">Submit</button>
      <button class="btn reject" id="pharmacistCancel">Cancel</button>
    </div>
  </div>
</div>

<div class="confirm-backdrop" id="confirmBackdrop">
  <div class="confirm-box">
    <p id="confirmMsg"></p>
    <button id="confirmYes" class="btn approve">Yes</button>
    <button id="confirmNo" class="btn reject">Cancel</button>
  </div>
</div>

<div class="modal-backdrop" id="reasonBackdrop">
  <div class="modal-box">
    <div class="modal-header"><h3>Disapproval Reason</h3></div>
    <div class="modal-body">
      <select id="rejectReason" style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:0.4rem;">
        <option>No infection</option>
        <option>Wrong choice</option>
        <option>Wrong dose</option>
        <option>Wrong route</option>
        <option>Wrong duration</option>
        <option>Others (specify)</option>
      </select>

      <input type="text" id="rejectReasonOther" placeholder="Specify..." style="margin-top:0.6rem; width:100%; padding:0.45rem; border:1px solid var(--border); border-radius:0.4rem; display:none;">

      <button class="btn approve" id="rejectSubmit">Submit</button>
      <button class="btn reject" id="rejectCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   CONFIG
   ========================================================== */
const API =
  "https://script.google.com/macros/s/AKfycbxqCMutMeG7CyDK68P8mkbxkkV-2o0S6XxoBYsPo6lG7jcAVppP8zPV6zuX6AJtfywh/exec";

let ALL_DATA = [];
let pendingAction = null;
let tempFileId = null;
let tempEntry = null;
let currentRejectFileId = null;

/* ==========================================================
   LOAD DATA
   ========================================================== */
async function loadData() {
  try {
    const res = await fetch(API);
    const json = await res.json();
    ALL_DATA = json.entries || [];
    renderAll();
  } catch (err) {
    console.error("Fetch error:", err);
  }
}

/* ==========================================================
   CONFIRMATION MODAL
   ========================================================== */
function confirmAction(message, callback) {
  document.getElementById("confirmMsg").textContent = message;
  pendingAction = callback;
  document.getElementById("confirmBackdrop").style.display = "flex";
}
document.getElementById("confirmNo").onclick = () => {
  pendingAction = null;
  document.getElementById("confirmBackdrop").style.display = "none";
};
document.getElementById("confirmYes").onclick = () => {
  if (pendingAction) pendingAction();
  pendingAction = null;
  document.getElementById("confirmBackdrop").style.display = "none";
};

/* ==========================================================
   REJECTION REASON MODAL
   ========================================================== */
document.getElementById("rejectReason").onchange = (e) => {
  document.getElementById("rejectReasonOther").style.display =
    e.target.value === "Others (specify)" ? "block" : "none";
};

document.getElementById("rejectCancel").onclick = () => {
  currentRejectFileId = null;
  document.getElementById("reasonBackdrop").style.display = "none";
};

document.getElementById("rejectSubmit").onclick = async () => {
  if (!currentRejectFileId) return;

  let reason = document.getElementById("rejectReason").value;
  if (reason === "Others (specify)") {
    const other = document.getElementById("rejectReasonOther").value.trim();
    if (other) reason = other;
  }

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "rejectWithReason",
      fileId: currentRejectFileId,
      reason,
    }),
  });

  currentRejectFileId = null;
  document.getElementById("reasonBackdrop").style.display = "none";
  loadData();
};

/* ==========================================================
   PHARMACIST MODAL
   ========================================================== */
function openPharmacistModal(fileId) {
  tempFileId = fileId;
  document.getElementById("pharmacistName").value = "";
  document.getElementById("pharmacistBackdrop").style.display = "flex";
}

document.getElementById("pharmacistCancel").onclick = () => {
  tempFileId = null;
  document.getElementById("pharmacistBackdrop").style.display = "none";
};

document.getElementById("pharmacistSubmit").onclick = async () => {
  const name = document.getElementById("pharmacistName").value.trim();
  if (!name) {
    alert("Pharmacist name required.");
    return;
  }

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "markDispensed",
      fileId: tempFileId,
      dispensedBy: name,
    }),
  });

  tempFileId = null;
  document.getElementById("pharmacistBackdrop").style.display = "none";
  loadData();
};

/* ==========================================================
   DETAILS MODAL
   ========================================================== */
function openDetails(entry) {
  tempEntry = entry;
  const d = entry.data;
  const box = document.getElementById("detailsBody");

  const serviceResidentLabel =
    d.mode === "adult"
      ? "Internal Medicine Resident"
      : "Pediatrics Resident";

  box.innerHTML = `
    <p><strong>Patient:</strong> ${d.patientName} (${d.age} y, ${d.sex})</p>
    <p><strong>Hospital #:</strong> ${d.hospitalNumber}</p>
    <p><strong>Ward:</strong> ${d.ward}</p>
    <p><strong>Diagnosis:</strong> ${d.diagnosis}</p>
    <hr>

    <p><strong>Drug:</strong> ${d.antimicrobial}</p>
    <p><strong>Dose:</strong> ${d.dose}</p>
    <p><strong>Frequency:</strong> ${d.frequency}</p>
    <p><strong>Duration:</strong> ${d.duration} days</p>
    <p><strong>Drug Type:</strong> ${d.drugType}</p>
    <p><strong>Indication:</strong> ${d.indication}</p>
    <hr>

    <p><strong>Scr:</strong> ${d.scrMgDl}</p>
    <p><strong>SGPT:</strong> ${d.sgpt}</p>
    <p><strong>eGFR:</strong> ${d.egfrText}</p>
    <hr>

    <p><strong>Resident:</strong> ${d.residentName} (${d.clinicalDept})</p>
    <p><strong>Date:</strong> ${d.reqDate}</p>

    ${
      d.drugType === "Restricted"
        ? `
        <p><strong>${serviceResidentLabel}:</strong> ${d.serviceResidentName}</p>
        <p><strong>IDS Specialist:</strong> ${d.idSpecialist}</p>
      `
        : ""
    }

    ${
      d.disapprovedReason
        ? `<p><strong>Disapproved Reason:</strong> ${d.disapprovedReason}</p>`
        : ""
    }

    ${
      d.dispensed
        ? `<p><strong>Dispensed:</strong> Yes, by ${d.dispensedBy || "Unknown"}</p>`
        : ""
    }

    <p><strong>Status:</strong> ${d.status}</p>

    <hr>
  `;

  document.getElementById("detailsBackdrop").style.display = "flex";
}

document.getElementById("detailsClose").onclick = () => {
  document.getElementById("detailsBackdrop").style.display = "none";
};

/* ==========================================================
   UPDATE STATUS
   ========================================================== */
async function updateStatus(fileId, status) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "updateStatus", fileId, status }),
  });
  loadData();
}

async function deleteEntry(fileId) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "deleteEntry", fileId }),
  });
  loadData();
}

/* ==========================================================
   RENDER PENDING CARDS
   ========================================================== */
function renderPending() {
  const date = document.getElementById("pendingDate").value;
  const search = document.getElementById("pendingSearch").value.trim();
  const container = document.getElementById("pendingList");
  container.innerHTML = "";

  const filtered = ALL_DATA.filter((e) => {
    const d = e.data;
    if (!d) return false;

    if (date && d.reqDate !== date) return false;
    if (search && !String(d.hospitalNumber).includes(search)) return false;

    return !["approved", "disapproved", "for_ids_approval"].includes(
      d.status
    );
  });

  filtered.forEach((entry) => {
    const d = entry.data;

    const serviceInfo =
      d.drugType === "Restricted"
        ? `
        <div><strong>${d.mode === "adult" ? "IM Resident" : "Pedia Resident"}:</strong> ${d.serviceResidentName}</div>
        <div><strong>IDS:</strong> ${d.idSpecialist}</div>
      `
        : "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header">
        <strong>${d.patientName} (${d.age} y)</strong>
        <span class="tag ${d.drugType.toLowerCase()}">${d.drugType}</span>
      </div>

      <div><strong>Hospital #:</strong> ${d.hospitalNumber}</div>
      <div><strong>Ward:</strong> ${d.ward}</div>
      <div><strong>Diagnosis:</strong> ${d.diagnosis}</div>
      <div><strong>Drug:</strong> ${d.antimicrobial}</div>
      <div><strong>Dose:</strong> ${d.dose}</div>
      <div><strong>Frequency:</strong> ${d.frequency}</div>
      <div><strong>Duration:</strong> ${d.duration} days</div>
      ${serviceInfo}
      <div><strong>Date:</strong> ${d.reqDate}</div>

      <div class="actions">
        ${
          d.drugType === "Restricted"
            ? `
              <button class="btn for-ids">For IDS Approval</button>
              <button class="btn reject">Disapprove</button>
              <button class="btn delete">Delete</button>
            `
            : `
              <button class="btn approve">Approve</button>
              <button class="btn reject">Disapprove</button>
              <button class="btn delete">Delete</button>
            `
        }
      </div>
    `;

    card.onclick = (ev) => {
      if (ev.target.closest("button")) return;
      openDetails(entry);
    };

    const approveBtn = card.querySelector(".approve");
    if (approveBtn)
      approveBtn.onclick = (ev) => {
        ev.stopPropagation();
        updateStatus(entry.fileId, "approved");
      };

    const idsBtn = card.querySelector(".for-ids");
    if (idsBtn)
      idsBtn.onclick = (ev) => {
        ev.stopPropagation();
        updateStatus(entry.fileId, "for_ids_approval");
      };

    const rejectBtn = card.querySelector(".reject");
    rejectBtn.onclick = (ev) => {
      ev.stopPropagation();
      currentRejectFileId = entry.fileId;
      document.getElementById("reasonBackdrop").style.display = "flex";
    };

    const deleteBtn = card.querySelector(".delete");
    deleteBtn.onclick = (ev) => {
      ev.stopPropagation();
      confirmAction("Delete this entry?", () => deleteEntry(entry.fileId));
    };

    container.appendChild(card);
  });
}

/* ==========================================================
   GENERIC LIST RENDERER
   ========================================================== */
function renderList(config) {
  const container = document.getElementById(config.listId);
  container.innerHTML = "";

  const date = document.getElementById(config.dateField).value;
  const search =
    config.searchField &&
    document.getElementById(config.searchField).value.trim();
  const idsFilter =
    config.idsField && document.getElementById(config.idsField).value;

  const filtered = ALL_DATA.filter((e) => {
    const d = e.data;
    if (!d) return false;

    if (config.matchStatus && d.status !== config.matchStatus) return false;
    if (config.onlyRestricted && d.drugType !== "Restricted") return false;
    if (config.excludeRestricted && d.drugType === "Restricted") return false;

    if (date && d.reqDate !== date) return false;

    if (search && !String(d.hospitalNumber).includes(search)) return false;
    if (idsFilter && d.idSpecialist !== idsFilter) return false;

    return true;
  });

  filtered.forEach((entry) => {
    const d = entry.data;

    const row = document.createElement("div");
    row.className = "list-item";

    row.innerHTML = `
      <div>
        <strong>${d.patientName}</strong> (${d.hospitalNumber})<br>
        ${d.antimicrobial} — ${d.dose} (${d.frequency})
        <br>
        ${
          d.drugType === "Restricted"
            ? `<span class="tag restricted">Restricted</span>`
            : `<span class="tag monitored">Monitored</span>`
        }
      </div>

      <div>${d.reqDate}</div>
    `;

    row.onclick = () => openDetails(entry);

    container.appendChild(row);
  });
}

/* ==========================================================
   DATA ANALYSIS
   ========================================================== */

function applyAnalysisFilters() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const ward = document.getElementById("wardFilter").value;

  const filtered = ALL_DATA.filter((e) => {
    const d = e.data;
    if (!d) return false;

    if (from && d.reqDate < from) return false;
    if (to && d.reqDate > to) return false;
    if (ward && d.ward !== ward) return false;

    return true;
  });

  renderAnalysisTiles(filtered);
  renderCharts(filtered);
  renderTopTables(filtered);
}

function renderAnalysisTiles(data) {
  const tiles = document.getElementById("analysisTiles");

  const total = data.length;
  const approved = data.filter((d) => d.data.status === "approved").length;
  const disapproved = data.filter((d) => d.data.status === "disapproved")
    .length;
  const restricted = data.filter((d) => d.data.drugType === "Restricted")
    .length;

  tiles.innerHTML = `
    <div class="tile">
      <div>Total Requests</div>
      <div class="tile-number">${total}</div>
    </div>
    <div class="tile">
      <div>Approved</div>
      <div class="tile-number">${approved}</div>
    </div>
    <div class="tile">
      <div>Disapproved</div>
      <div class="tile-number">${disapproved}</div>
    </div>
    <div class="tile">
      <div>Restricted</div>
      <div class="tile-number">${restricted}</div>
    </div>
  `;
}

/* --------------------------
   CHARTS
   -------------------------- */
let chartRequests, chartTypes, chartApproval;

function renderCharts(data) {
  const ctx1 = document.getElementById("chartRequests").getContext("2d");
  const ctx2 = document.getElementById("chartTypes").getContext("2d");
  const ctx3 = document.getElementById("chartApproval").getContext("2d");

  const byDate = {};
  const typeCount = { Monitored: 0, Restricted: 0 };
  const approvalCount = { approved: 0, disapproved: 0 };

  data.forEach((e) => {
    const d = e.data;
    byDate[d.reqDate] = (byDate[d.reqDate] || 0) + 1;
    typeCount[d.drugType] = (typeCount[d.drugType] || 0) + 1;
    approvalCount[d.status] = (approvalCount[d.status] || 0) + 1;
  });

  if (chartRequests) chartRequests.destroy();
  if (chartTypes) chartTypes.destroy();
  if (chartApproval) chartApproval.destroy();

  chartRequests = new Chart(ctx1, {
    type: "line",
    data: {
      labels: Object.keys(byDate),
      datasets: [
        {
          label: "Requests per Day",
          data: Object.values(byDate),
          borderColor: "#009a3e",
          fill: false,
          tension: 0.2,
        },
      ],
    },
  });

  chartTypes = new Chart(ctx2, {
    type: "pie",
    data: {
      labels: ["Monitored", "Restricted"],
      datasets: [
        {
          data: [typeCount.Monitored, typeCount.Restricted],
          backgroundColor: ["#10b981", "#ef4444"],
        },
      ],
    },
  });

  chartApproval = new Chart(ctx3, {
    type: "bar",
    data: {
      labels: ["Approved", "Disapproved"],
      datasets: [
        {
          data: [approvalCount.approved, approvalCount.disapproved],
          backgroundColor: ["#009a3e", "#dc2626"],
        },
      ],
    },
  });
}

/* --------------------------
   TOP TABLES
   -------------------------- */
function renderTopTables(data) {
  const byAbx = {};
  const byWard = {};

  data.forEach((e) => {
    const d = e.data;
    byAbx[d.antimicrobial] = (byAbx[d.antimicrobial] || 0) + 1;
    byWard[d.ward] = (byWard[d.ward] || 0) + 1;
  });

  const topAbx = Object.entries(byAbx)
    .sort((a, b) => b[1] - a[1])
    .map(([k, v]) => `<div>${k}: <strong>${v}</strong></div>`)
    .join("");

  const topWards = Object.entries(byWard)
    .sort((a, b) => b[1] - a[1])
    .map(([k, v]) => `<div>${k}: <strong>${v}</strong></div>`)
    .join("");

  document.getElementById("topAbx").innerHTML = topAbx || "No data";
  document.getElementById("topWards").innerHTML = topWards || "No data";
}

/* ==========================================================
   CSV EXPORTERS
   ========================================================== */
function convertToCSV(data) {
  const header = [
    "Patient Name",
    "Hospital #",
    "Ward",
    "Drug",
    "Dose",
    "Frequency",
    "Duration",
    "Drug Type",
    "Resident",
    "Date",
    "Status",
  ].join(",");

  const rows = data.map((e) => {
    const d = e.data;
    return [
      d.patientName,
      d.hospitalNumber,
      d.ward,
      d.antimicrobial,
      d.dose,
      d.frequency,
      d.duration,
      d.drugType,
      d.residentName,
      d.reqDate,
      d.status,
    ].join(",");
  });

  return header + "\n" + rows.join("\n");
}

function downloadCSV(filename, csv) {
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  a.href = url;
  a.download = filename;
  a.click();
}

document.getElementById("exportAllCsv").onclick = () => {
  const csv = convertToCSV(ALL_DATA);
  downloadCSV("All_Requests.csv", csv);
};

document.getElementById("exportFilteredCsv").onclick = () => {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const ward = document.getElementById("wardFilter").value;

  const filtered = ALL_DATA.filter((e) => {
    const d = e.data;
    if (!d) return false;
    if (from && d.reqDate < from) return false;
    if (to && d.reqDate > to) return false;
    if (ward && d.ward !== ward) return false;
    return true;
  });

  const csv = convertToCSV(filtered);
  downloadCSV("Filtered_Requests.csv", csv);
};

/* ==========================================================
   GENERATE WARD OPTIONS
   ========================================================== */
function loadWardOptions() {
  const wards = [...new Set(ALL_DATA.map((e) => e.data.ward))].sort();
  const select = document.getElementById("wardFilter");

  select.innerHTML = '<option value="">All Wards</option>';
  wards.forEach((w) => {
    select.innerHTML += `<option>${w}</option>`;
  });
}

/* ==========================================================
   RENDER ALL
   ========================================================== */
function renderAll() {
  renderPending();

  renderList({
    listId: "approvedList",
    dateField: "approvedDate",
    searchField: "approvedSearch",
    matchStatus: "approved",
  });

  renderList({
    listId: "rejectedList",
    dateField: "rejectedDate",
    searchField: "rejectedSearch",
    matchStatus: "disapproved",
  });

  renderList({
    listId: "idsList",
    dateField: "idsDate",
    idsField: "idsFilter",
    matchStatus: "for_ids_approval",
    onlyRestricted: true,
  });

  loadWardOptions();
}

/* ==========================================================
   TAB SWITCHING
   ========================================================== */
document.querySelectorAll(".tab-btn").forEach((btn) => {
  btn.onclick = () => {
    document
      .querySelectorAll(".tab-btn")
      .forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");

    document
      .querySelectorAll(".section")
      .forEach((s) => s.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");

    renderAll();
  };
});

document.getElementById("applyAnalysis").onclick = applyAnalysisFilters;

/* ==========================================================
   INIT
   ========================================================== */
window.onload = loadData;
</script>

</body>
</html>
