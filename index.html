<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ospital ng Makati – Antimicrobial Request System (Pharmacy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
/* =========================================================
   THEME
========================================================= */
:root {
  --osmak-green: #009a3e;
  --osmak-green-dark: #007530;
  --osmak-red: #dc2626;
  --bg-main: #f5f5f5;
  --bg-card: #ffffff;
  --text-main: #111827;
  --text-muted: #6b7280;
  --border: #d1d5db;
  --pill-red-bg: rgba(220,38,38,0.15);
  --pill-green-bg: rgba(0,154,62,0.15);
}

/* =========================================================
   BASE
========================================================= */
body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

/* =========================================================
   HEADER
========================================================= */
header {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: var(--osmak-green);
  color: #fff;
  padding: 0.75rem 1rem;
}

header img {
  height: 48px;
}

header h1 {
  margin: 0;
  font-size: 1.2rem;
  text-transform: uppercase;
}
header span {
  font-size: 0.85rem;
  opacity: 0.9;
}

/* =========================================================
   MAIN WRAPPER
========================================================= */
.main {
  max-width: 1200px;
  margin: 1rem auto 3rem;
  padding: 0 1rem;
}

/* =========================================================
   TABS
========================================================= */
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.tab-btn {
  background: #fff;
  border: 1px solid var(--border);
  padding: 0.5rem 1rem;
  border-radius: 0.4rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
}
.tab-btn.active {
  background: var(--osmak-green);
  color: #fff;
  border-color: var(--osmak-green-dark);
}

/* =========================================================
   SECTIONS
========================================================= */
.section {
  display: none;
}
.section.active {
  display: block;
}

/* =========================================================
   FILTER ROWS
========================================================= */
.search-row {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 0.6rem;
}

.search-row input,
.search-row select {
  padding: 0.45rem;
  border: 1px solid var(--border);
  border-radius: 0.4rem;
  font-size: 0.9rem;
}

/* =========================================================
   CARD STYLE (PENDING)
========================================================= */
.card {
  background: var(--bg-card);
  padding: 1rem 1.2rem;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  margin-bottom: 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: background 0.2s;
}

.card:hover {
  background: #fafafa;
}

/* Header row */
.card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.4rem;
  font-size: 1rem;
}

/* Drug type pill */
.tag {
  padding: 0.15rem 0.6rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
}
.tag.monitored {
  background: var(--pill-green-bg);
  color: var(--osmak-green-dark);
}
.tag.restricted {
  background: var(--pill-red-bg);
  color: var(--osmak-red);
}

/* =========================================================
   BUTTONS (Option A — Solid Buttons)
========================================================= */
.btn {
  border: none;
  padding: 0.45rem 0.9rem;
  font-size: 0.78rem;
  border-radius: 0.4rem;
  cursor: pointer;
  font-weight: 600;
}

.btn.approve { background: var(--osmak-green); color: white; }
.btn.reject { background: var(--osmak-red); color: white; }
.btn.for-ids { background: #f59e0b; color: #fff; }
.btn.delete { background: #6b7280; color: #fff; }
.btn.cancel { background: #374151; color: #fff; }

/* Action container */
.actions {
  margin-top: 0.7rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
}

/* =========================================================
   LIST VIEW (Approved / Rejected / Dispensed / IDS)
========================================================= */
.list-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  background: #fff;
}

.list-item {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}
.list-item:hover {
  background: #f1f5f9;
}
.list-item:last-child {
  border-bottom: none;
}

/* =========================================================
   MODALS
========================================================= */
.modal-backdrop,
.confirm-backdrop,
.pharmacist-backdrop,
.reason-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.modal-box {
  background: #fff;
  border-radius: 0.75rem;
  width: 92%;
  max-width: 750px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
}

.modal-header {
  padding: 0.9rem 1.2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body {
  padding: 1rem 1.2rem;
  font-size: 0.9rem;
  line-height: 1.45rem;
}

.close-btn {
  background: transparent;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
}

/* Pharmacist input */
.pharm-input,
.reason-input {
  width: 100%;
  padding: 0.55rem;
  border: 1px solid var(--border);
  border-radius: 0.4rem;
  margin-bottom: 0.7rem;
}
  </style>
</head>

<body>

<!-- =========================================================
     HEADER
========================================================= -->
<header>
  <img src="https://maxterrenal-hash.github.io/justculture/osmak-logo.png">
  <div>
    <h1>Antimicrobial Request System</h1>
    <span>Pharmacy Module</span>
  </div>
</header>

<div class="main">

  <!-- =========================================================
       TABS
  ========================================================= -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending</button>
    <button class="tab-btn" data-tab="approved">Approved</button>
    <button class="tab-btn" data-tab="rejected">Rejected</button>
    <button class="tab-btn" data-tab="dispensed">Dispensed</button>
    <button class="tab-btn" data-tab="ids">IDS Approval</button>
  </div>

  <!-- =========================================================
       PENDING (NO FILTERS)
  ========================================================= -->
  <div class="section active" id="pending">
    <div id="pendingList"></div>
  </div>

  <!-- =========================================================
       APPROVED
  ========================================================= -->
  <div class="section" id="approved">
    <div class="search-row">
      <input type="date" id="approvedDate">
      <input type="text" id="approvedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="approvedList"></div>
  </div>

  <!-- =========================================================
       REJECTED
  ========================================================= -->
  <div class="section" id="rejected">
    <div class="search-row">
      <input type="date" id="rejectedDate">
      <input type="text" id="rejectedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="rejectedList"></div>
  </div>

  <!-- =========================================================
       DISPENSED
  ========================================================= -->
  <div class="section" id="dispensed">
    <div class="search-row">
      <input type="date" id="dispensedDate">
      <input type="text" id="dispensedSearch" placeholder="Search Hospital Number">
    </div>
    <div class="list-container" id="dispensedList"></div>
  </div>

  <!-- =========================================================
       IDS APPROVAL
  ========================================================= -->
  <div class="section" id="ids">
    <div class="search-row">
      <select id="idsFilter">
        <option value="">Filter by IDS</option>
        <option>Dr. Christopher John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
      <input type="date" id="idsDate">
    </div>
    <div class="list-container" id="idsList"></div>
  </div>

</div>

<!-- =========================================================
     FULL DETAILS MODAL
========================================================= -->
<div class="modal-backdrop" id="detailsBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Request Details</h3>
      <button class="close-btn" id="detailsClose">✕</button>
    </div>
    <div class="modal-body" id="detailsBody"></div>
  </div>
</div>

<!-- =========================================================
     PHARMACIST NAME MODAL
========================================================= -->
<div class="modal-backdrop pharmacist-backdrop" id="pharmacistBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Dispensed By</h3>
    </div>
    <div class="modal-body">
      <input type="text" id="pharmacistName" class="pharm-input" placeholder="Enter pharmacist name">
      <button class="btn approve" id="pharmacistSubmit">Submit</button>
      <button class="btn delete" id="pharmacistCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- =========================================================
     REJECT REASON MODAL
========================================================= -->
<div class="modal-backdrop reason-backdrop" id="reasonBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Reason for Disapproval</h3>
    </div>
    <div class="modal-body">
      <select id="reasonSelect" class="reason-input">
        <option value="">Select reason</option>
        <option>No infection</option>
        <option>Wrong choice</option>
        <option>Wrong dose</option>
        <option>Wrong route</option>
        <option>Wrong duration</option>
        <option>Others</option>
      </select>

      <textarea id="reasonOther" class="reason-input" placeholder="Specify if Others..." style="display:none;"></textarea>

      <button class="btn reject" id="reasonSubmit">Submit</button>
      <button class="btn delete" id="reasonCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const API = "https://script.google.com/macros/s/AKfycbxqCMutMeG7CyDK68P8mkbxkkV-2o0S6XxoBYsPo6lG7jcAVppP8zPV6zuX6AJtfywh/exec";

let ALL_DATA = [];
let rejectFileId = null;

/* =========================================================
   AUTO-REFRESH (Event-driven push simulation)
========================================================= */
setInterval(() => loadData(false), 2000);

/* =========================================================
   FETCH ALL DATA
========================================================= */
async function loadData(showLoading = true) {
  try {
    const res = await fetch(API);
    const data = await res.json();
    ALL_DATA = data.entries || [];
    renderAll();
  } catch (err) {
    console.error("Fetch error:", err);
  }
}

/* =========================================================
   OPEN DETAILS MODAL
========================================================= */
function openDetails(entry) {
  const d = entry.data;
  const body = document.getElementById("detailsBody");

  const sr = d.mode === "adult" ? "Internal Medicine Resident" : "Pediatrics Resident";

  body.innerHTML = `
    <p><strong>Patient:</strong> ${d.patientName} (${d.age} y, ${d.sex})</p>
    <p><strong>Hospital #:</strong> ${d.hospitalNumber}</p>
    <p><strong>Ward:</strong> ${d.ward}</p>
    <p><strong>Diagnosis:</strong> ${d.diagnosis}</p>
    <hr>

    <p><strong>Drug:</strong> ${d.antimicrobial}</p>
    <p><strong>Dose:</strong> ${d.dose}</p>
    <p><strong>Frequency:</strong> ${d.frequency}</p>
    <p><strong>Duration:</strong> ${d.duration} days</p>
    <p><strong>Type:</strong> <span class="tag ${d.drugType.toLowerCase()}">${d.drugType}</span></p>
    <p><strong>Indication:</strong> ${d.indication}</p>
    <hr>

    <p><strong>Scr:</strong> ${d.scrMgDl}</p>
    <p><strong>SGPT:</strong> ${d.sgpt}</p>
    <p><strong>eGFR:</strong> ${d.egfrText}</p>
    <hr>

    <p><strong>Resident:</strong> ${d.residentName} (${d.clinicalDept})</p>
    <p><strong>Date:</strong> ${d.reqDate}</p>

    ${
      d.drugType === "Restricted"
        ? `
          <p><strong>${sr}:</strong> ${d.serviceResidentName}</p>
          <p><strong>IDS:</strong> ${d.idSpecialist}</p>
        `
        : ""
    }

    ${
      d.dispensed
        ? `<p><strong>Dispensed by:</strong> ${d.dispensedBy || "Unknown"}</p>`
        : ""
    }

    <p><strong>Status:</strong> ${d.status}</p>

    ${
      d.rejectReason
        ? `<p><strong>Reject Reason:</strong> ${d.rejectReason}</p>`
        : ""
    }
  `;

  document.getElementById("detailsBackdrop").style.display = "flex";
}

document.getElementById("detailsClose").onclick = () =>
  (document.getElementById("detailsBackdrop").style.display = "none");

/* =========================================================
   REJECT REASON MODAL
========================================================= */
document.getElementById("reasonSelect").onchange = () => {
  const sel = document.getElementById("reasonSelect").value;
  document.getElementById("reasonOther").style.display =
    sel === "Others" ? "block" : "none";
};

document.getElementById("reasonCancel").onclick = () => {
  rejectFileId = null;
  document.getElementById("reasonBackdrop").style.display = "none";
};

document.getElementById("reasonSubmit").onclick = async () => {
  if (!rejectFileId) return;

  let reason = document.getElementById("reasonSelect").value;
  if (!reason) return alert("Select a reason");

  if (reason === "Others") {
    const txt = document.getElementById("reasonOther").value.trim();
    if (!txt) return alert("Specify reason");
    reason = txt;
  }

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "updateStatus",
      fileId: rejectFileId,
      status: "disapproved",
      rejectReason: reason
    })
  });

  rejectFileId = null;
  document.getElementById("reasonBackdrop").style.display = "none";
  loadData();
};

/* =========================================================
   PHARMACIST MODAL
========================================================= */
let dispenseFileId = null;

function openPharmacistModal(id) {
  dispenseFileId = id;
  document.getElementById("pharmacistBackdrop").style.display = "flex";
}

document.getElementById("pharmacistCancel").onclick = () => {
  dispenseFileId = null;
  document.getElementById("pharmacistBackdrop").style.display = "none";
};

document.getElementById("pharmacistSubmit").onclick = async () => {
  const name = document.getElementById("pharmacistName").value.trim();
  if (!name) return alert("Enter pharmacist name");

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "markDispensed",
      fileId: dispenseFileId,
      dispensedBy: name
    })
  });

  document.getElementById("pharmacistBackdrop").style.display = "none";
  loadData();
};

/* =========================================================
   GENERIC SERVER ACTIONS
========================================================= */
async function updateStatus(fileId, status, reason = null) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "updateStatus", fileId, status, rejectReason: reason })
  });
  loadData();
}

async function deleteEntry(fileId) {
  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "deleteEntry", fileId })
  });
  loadData();
}

/* =========================================================
   RENDER PENDING (LAYOUT C)
========================================================= */
function renderPending() {
  const parent = document.getElementById("pendingList");
  parent.innerHTML = "";

  const list = ALL_DATA.filter(e => {
    const s = e.data.status;
    return !["approved", "disapproved", "dispensed", "for_ids_approval"].includes(s);
  });

  list.forEach(entry => {
    const d = entry.data;

    const pillClass = d.drugType === "Restricted" ? "restricted" : "monitored";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header">
        <strong>${d.patientName} — ${d.ward}</strong>
        <span class="tag ${pillClass}">${d.drugType}</span>
      </div>

      <div><strong>${d.antimicrobial}</strong></div>
      <div class="text-muted">${d.reqDate}</div>

      <div class="actions">
        ${
          d.drugType === "Restricted"
            ? `
              <button class="btn for-ids">Dispense</button>
              <button class="btn reject">Disapprove</button>
              <button class="btn delete">Delete</button>
            `
            : `
              <button class="btn approve">Approve</button>
              <button class="btn reject">Disapprove</button>
              <button class="btn delete">Delete</button>
            `
        }
      </div>
    `;

    /* Clicking background = open details */
    card.onclick = (ev) => {
      if (ev.target.tagName === "BUTTON") return;
      openDetails(entry);
    };

    /* Approve (Monitored only) */
    if (card.querySelector(".approve")) {
      card.querySelector(".approve").onclick = (ev) => {
        ev.stopPropagation();
        updateStatus(entry.fileId, "approved");
      };
    }

    /* Dispense (Restricted only) */
    if (card.querySelector(".for-ids")) {
      card.querySelector(".for-ids").onclick = (ev) => {
        ev.stopPropagation();
        openPharmacistModal(entry.fileId);
      };
    }

    /* Disapprove w/ reason */
    card.querySelector(".reject").onclick = (ev) => {
      ev.stopPropagation();
      rejectFileId = entry.fileId;
      document.getElementById("reasonBackdrop").style.display = "flex";
    };

    /* Delete */
    card.querySelector(".delete").onclick = (ev) => {
      ev.stopPropagation();
      deleteEntry(entry.fileId);
    };

    parent.appendChild(card);
  });
}

/* =========================================================
   GENERIC LIST RENDERER
========================================================= */
function renderList({ listId, dateId, searchId, idsId, status, restrictedOnly, excludeRestricted }) {
  const parent = document.getElementById(listId);
  parent.innerHTML = "";

  const date = document.getElementById(dateId)?.value;
  const search = searchId ? document.getElementById(searchId).value.trim() : "";
  const ids = idsId ? document.getElementById(idsId).value : "";

  const list = ALL_DATA.filter(e => {
    const d = e.data;
    if (!d) return false;

    if (status && d.status !== status) return false;
    if (restrictedOnly && d.drugType !== "Restricted") return false;
    if (excludeRestricted && d.drugType === "Restricted") return false;

    if (date && d.reqDate !== date) return false;
    if (search && !String(d.hospitalNumber).includes(search)) return false;
    if (ids && d.idSpecialist !== ids) return false;

    return true;
  });

  list.forEach(entry => {
    const d = entry.data;

    const row = document.createElement("div");
    row.className = "list-item";
    row.innerHTML = `
      <div>
        <strong>${d.patientName}</strong> (${d.hospitalNumber})<br>
        ${d.antimicrobial}
      </div>
      <div>${d.reqDate}</div>
    `;

    row.onclick = () => openDetails(entry);

    /* Add Cancel Approve / Cancel Reject buttons */
    if (status === "approved") {
      const btn = document.createElement("button");
      btn.className = "btn cancel";
      btn.textContent = "Cancel Approval";
      btn.onclick = (ev) => {
        ev.stopPropagation();
        updateStatus(entry.fileId, "disapproved");
      };
      row.appendChild(btn);
    }

    if (status === "disapproved") {
      const btn = document.createElement("button");
      btn.className = "btn approve";
      btn.textContent = "Cancel Rejection";
      btn.onclick = (ev) => {
        ev.stopPropagation();
        updateStatus(entry.fileId, "approved");
      };
      row.appendChild(btn);
    }

    parent.appendChild(row);
  });
}

/* =========================================================
   RENDER ALL
========================================================= */
function renderAll() {
  renderPending();

  renderList({
    listId: "approvedList",
    dateId: "approvedDate",
    searchId: "approvedSearch",
    status: "approved",
    excludeRestricted: true
  });

  renderList({
    listId: "rejectedList",
    dateId: "rejectedDate",
    searchId: "rejectedSearch",
    status: "disapproved"
  });

  renderList({
    listId: "dispensedList",
    dateId: "dispensedDate",
    searchId: "dispensedSearch",
    status: "dispensed",
    excludeRestricted: true
  });

  renderList({
    listId: "idsList",
    dateId: "idsDate",
    idsId: "idsFilter",
    status: "for_ids_approval",
    restrictedOnly: true
  });
}

/* =========================================================
   TAB SWITCHING
========================================================= */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");

    renderAll();
  };
});

/* =========================================================
   INIT
========================================================= */
window.onload = () => {
  const today = new Date().toISOString().split("T")[0];
  ["approvedDate","rejectedDate","dispensedDate","idsDate"].forEach(id => {
    document.getElementById(id).value = today;
  });
  loadData();
};
</script>

</body>
</html>
